name: Daily Game Generator

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-game:
    runs-on: ubuntu-latest
    outputs:
      game-generated: ${{ steps.check-changes.outputs.game-generated }}
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Create branch for new game
        id: create-branch
        run: |
          TODAY=$(date +'%Y-%m-%d')
          BRANCH_NAME="game/$TODAY"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          git checkout -b "$BRANCH_NAME"
          
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Daily Game Bot"
          
      - name: Generate Daily Game with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --model claude-sonnet-4-6
            --dangerously-skip-permissions
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: agent
          prompt: |
            Generate today's daily game following all instructions in Claude.md.

            IMPORTANT: Work in the current directory. All file paths must be relative.
            Do NOT use /tmp or absolute paths.

            CRITICAL REQUIREMENTS:
            1. Read and analyze games-registry.json to see all existing games
            2. Ensure the new game is mechanically unique and different from the last 7 games
            3. Create the date folder: games/YYYY-MM-DD/ (use today's actual date)
            4. Create a complete standalone HTML file: games/YYYY-MM-DD/index.html
               - Single HTML file with React 18 and ReactDOM loaded from unpkg.com CDN
               - Include Babel standalone from unpkg.com for JSX transpilation
               - All game code goes in a <script type="text/babel"> tag
               - Must be fully playable when opened directly in a browser
            5. Create the test file: games/YYYY-MM-DD/game.test.js
               - Tests MUST load /games/YYYY-MM-DD/index.html (NOT .jsx or .js)
               - Include all 6 required tests (load, render, input, rapid input, mobile, localStorage)
            6. Update games-registry.json with the new entry
               - Set "file" to "games/YYYY-MM-DD/index.html"

            Complete the full workflow in one shot. Follow the quality checklist in Claude.md.

      - name: Debug - Check git state
        run: |
          echo "ðŸ“‚ Working directory: $(pwd)"
          echo ""
          echo "ðŸ“œ Recent commits (last 5):"
          git log --oneline -5
          echo ""
          echo "ðŸ“„ Git status (uncommitted changes):"
          git status --short
          echo ""
          echo "ðŸ“ Contents of games/:"
          ls -laR games/ 2>/dev/null || echo "No games directory found"

      - name: Check for changes
        id: check-changes
        run: |
          # Stage any uncommitted files first
          git add -A

          STAGED_COUNT=$(git diff --staged --name-only | wc -l | tr -d ' ')
          COMMITS_AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")

          echo "ðŸ“Š Commits ahead of main: $COMMITS_AHEAD"
          echo "ðŸ“Š Uncommitted staged files: $STAGED_COUNT"

          if [ "$STAGED_COUNT" -gt 0 ]; then
            # Uncommitted files found â€” commit them now
            TODAY=$(date +'%Y-%m-%d')
            git commit -m "ðŸŽ® Daily Game Generated - $TODAY"
            echo "âœ… Committed $STAGED_COUNT new/modified file(s)"
            echo "game-generated=true" >> $GITHUB_OUTPUT

          elif [ "$COMMITS_AHEAD" -gt 0 ]; then
            # Claude already committed â€” nothing to do except confirm
            echo "âœ… Claude Code committed $COMMITS_AHEAD ahead of main"
            echo "game-generated=true" >> $GITHUB_OUTPUT

          else
            echo "âŒ No new game generated â€” branch is even with main and no staged changes"
            echo "game-generated=false" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "ðŸ“ Changed vs main:"
          git diff origin/main...HEAD --stat || echo "(none)"

      - name: Push branch
        if: steps.check-changes.outputs.game-generated == 'true'
        run: |
          git push origin "${{ steps.create-branch.outputs.branch-name }}"

  test-games:
    needs: generate-game
    if: needs.generate-game.outputs.game-generated == 'true'
    runs-on: ubuntu-latest
    outputs:
      tests-passed: ${{ steps.run-tests.outputs.tests-passed }}
    
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.generate-game.outputs.branch-name }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install -D @playwright/test http-server
          npx playwright install --with-deps chromium

      - name: List all test files
        run: |
          echo "ðŸ§ª All test files found:"
          find games -name "game.test.js" | sort
          echo ""
          echo "Total: $(find games -name "game.test.js" | wc -l) test suite(s)"
          
      - name: Run all game tests
        id: run-tests
        run: |
          TEST_FILES=$(find games -name "game.test.js" | sort)

          if [ -z "$TEST_FILES" ]; then
            echo "âŒ No test files found"
            echo "tests-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "ðŸ§ª Running tests for all $(echo "$TEST_FILES" | wc -l) game(s)..."

          if npx playwright test $TEST_FILES; then
            echo "âœ… All games passed!"
            echo "tests-passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ One or more games failed!"
            echo "tests-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  merge-to-main:
    needs: [generate-game, test-games]
    if: needs.test-games.outputs.tests-passed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "Daily Game Bot"
          
      - name: Merge to main
        run: |
          git fetch origin
          git checkout main
          git merge --no-ff origin/${{ needs.generate-game.outputs.branch-name }} -m "Merge daily game from ${{ needs.generate-game.outputs.branch-name }}"
          git push origin main
          
      - name: Delete branch
        run: |
          git push origin --delete ${{ needs.generate-game.outputs.branch-name }}
          
      - name: Create Summary
        run: |
          echo "## ðŸŽ® Daily Game Merged to Main!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All games passed regression tests" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Merged from branch: ${{ needs.generate-game.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Ready for deployment" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: merge-to-main
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Create Summary
        run: |
          echo "## ðŸŽ® Daily Game Deployed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All games passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Merged to main" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Visit [the gallery](${{ steps.deployment.outputs.page_url }}) to play!" >> $GITHUB_STEP_SUMMARY
